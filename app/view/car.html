<!--
 * :file description: 
 * :name: /digital/app/view/car.html
 * :author: 张德志
 * :copyright: (c) 2023, Tungee
 * :date created: 2023-06-10 21:21:37
 * :last editor: 张德志
 * :date last edited: 2023-06-10 21:35:54
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小汽车</title>
    <script src="http://www.yanhuangxueyuan.com/versions/threejsR92/build/three.js"></script>
    <script src="http://www.yanhuangxueyuan.com/versions/threejsR92/examples/js/controls/OrbitControls.js"></script>
    
</head>

<body>
    <div id="info">

        <span class="colorPicker"><input id="body-color" type="color" value="#ff0000"></input><br />Body</span>
        <span class="colorPicker"><input id="details-color" type="color" value="#ffffff"></input><br />Details</span>
        <span class="colorPicker"><input id="glass-color" type="color" value="#ffffff"></input><br />Glass</span>
    </div>

</body>
<script type="module">
    import * as THREE from "three";

import Stats from "stats.js";

import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/examples/jsm/loaders/DRACOLoader.js";
import { RGBELoader } from "three/examples/jsm/loaders/RGBELoader.js";

let camera, scene, renderer;
let stats;

let grid;
let controls;

const wheels = [];

function init() {
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setAnimationLoop(render);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 0.85;
  document.body.appendChild(renderer.domElement);

  window.addEventListener("resize", onWindowResize);

  stats = new Stats();
  document.body.appendChild(stats.dom);

  //

  camera = new THREE.PerspectiveCamera(
    40,
    window.innerWidth / window.innerHeight,
    0.1,
    100
  );
  camera.position.set(4.25, 1.4, -4.5);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.maxDistance = 9;
  controls.maxPolarAngle = THREE.MathUtils.degToRad(90);
  controls.target.set(0, 0.5, 0);
  controls.update();

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x333333);
  scene.environment = new RGBELoader().load(
    "https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr"
  );
  scene.environment.mapping = THREE.EquirectangularReflectionMapping;
  scene.fog = new THREE.Fog(0x333333, 10, 15);

  grid = new THREE.GridHelper(20, 40, 0xffffff, 0xffffff);
  grid.material.opacity = 0.2;
  grid.material.depthWrite = false;
  grid.material.transparent = true;
  scene.add(grid);

  // materials

  const bodyMaterial = new THREE.MeshPhysicalMaterial({
    color: 0xff0000,
    metalness: 1.0,
    roughness: 0.5,
    clearcoat: 1.0,
    clearcoatRoughness: 0.03,
  });

  const detailsMaterial = new THREE.MeshStandardMaterial({
    color: 0xffffff,
    metalness: 1.0,
    roughness: 0.5,
  });

  const glassMaterial = new THREE.MeshPhysicalMaterial({
    color: 0xffffff,
    metalness: 0.25,
    roughness: 0,
    transmission: 1.0,
  });

  const bodyColorInput = document.getElementById("body-color");
  bodyColorInput.addEventListener("input", function () {
    bodyMaterial.color.set(this.value);
  });

  const detailsColorInput = document.getElementById("details-color");
  detailsColorInput.addEventListener("input", function () {
    detailsMaterial.color.set(this.value);
  });

  const glassColorInput = document.getElementById("glass-color");
  glassColorInput.addEventListener("input", function () {
    glassMaterial.color.set(this.value);
  });

  // Car

  const shadow = new THREE.TextureLoader().load(
    "https://threejs.org/examples/models/gltf/ferrari_ao.png"
  );

  const dracoLoader = new DRACOLoader();
  dracoLoader.setDecoderPath(
    "https://threejs.org/examples/jsm/libs/draco/gltf/"
  );

  const loader = new GLTFLoader();
  loader.setDRACOLoader(dracoLoader);

  loader.load(
    "https://threejs.org/examples/models/gltf/ferrari.glb",
    function (gltf) {
      const carModel = gltf.scene.children[0];

      carModel.getObjectByName("body").material = bodyMaterial;

      carModel.getObjectByName("rim_fl").material = detailsMaterial;
      carModel.getObjectByName("rim_fr").material = detailsMaterial;
      carModel.getObjectByName("rim_rr").material = detailsMaterial;
      carModel.getObjectByName("rim_rl").material = detailsMaterial;
      carModel.getObjectByName("trim").material = detailsMaterial;

      carModel.getObjectByName("glass").material = glassMaterial;

      wheels.push(
        carModel.getObjectByName("wheel_fl"),
        carModel.getObjectByName("wheel_fr"),
        carModel.getObjectByName("wheel_rl"),
        carModel.getObjectByName("wheel_rr")
      );

      // shadow
      const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(0.655 * 4, 1.3 * 4),
        new THREE.MeshBasicMaterial({
          map: shadow,
          blending: THREE.MultiplyBlending,
          toneMapped: false,
          transparent: true,
        })
      );
      mesh.rotation.x = -Math.PI / 2;
      mesh.renderOrder = 2;
      carModel.add(mesh);

      scene.add(carModel);
    }
  );
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();

  renderer.setSize(window.innerWidth, window.innerHeight);
}

function render() {
  controls.update();

  const time = -performance.now() / 1000;

  for (let i = 0; i < wheels.length; i++) {
    wheels[i].rotation.x = time * Math.PI * 2;
  }

  grid.position.z = -time % 1;

  renderer.render(scene, camera);

  stats.update();
}

init();

</script>

</html>